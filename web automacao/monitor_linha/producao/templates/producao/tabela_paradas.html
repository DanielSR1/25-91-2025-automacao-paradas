<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Paradas da Linha</title>
    
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" crossorigin="anonymous">

    <style>
        body { font-family: Arial, sans-serif; }
        fieldset { border: none; text-align: left; margin: 0; padding: 0; } 
        #modalExportar .modal-body button { display: block; width: 100%; margin-bottom: 5px; }
        .container { padding-top: 20px; }
    </style>

    <script>
        function enviarMotivo(nome_linha, inicio_parada, fim_parada, motivo) {
            fetch("{% url 'registrar_motivo' %}", {
                method: "POST",
                headers: {
                    "Content-Type": "application/x-www-form-urlencoded",
                    "X-CSRFToken": "{{ csrf_token }}"
                },
                body: new URLSearchParams({
                    nome_linha: nome_linha,
                    inicio_parada: inicio_parada,
                    fim_parada: fim_parada,
                    motivo: motivo
                })
            }).then(response => {
                if (response.ok) {
                    location.reload();
                }
            });
        }

        function abrirModal() {
            var modal = new bootstrap.Modal(document.getElementById('modalExportar'));
            modal.show();
        }

        function fecharModal() {
            var modalElement = document.getElementById('modalExportar');
            var modal = bootstrap.Modal.getInstance(modalElement);
            if (modal) {
                modal.hide();
            } else {
                modalElement.classList.remove('show');
                modalElement.style.display = 'none';
                document.querySelector('.modal-backdrop')?.remove();
            }
        }

        // Ajuste principal: caminho correto para exportar CSV
        function baixarCSV(filtro) {
            window.location.href = "{% url 'exportar_csv' filtro='FILTRO_TEMP' %}".replace('FILTRO_TEMP', filtro);
            fecharModal();
        }
    </script>
</head>
<body>
    <div class="container">
        <h1 class="my-4">Status de Paradas da Linha</h1>

        <button type="button" class="btn btn-primary mb-3" data-bs-toggle="modal" data-bs-target="#modalExportar">
            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-download" viewBox="0 0 16 16">
                <path d="M.5 9.9a.5.5 0 0 1 .5.5v2.5a1 1 0 0 0 1 1h12a1 1 0 0 0 1-1v-2.5a.5.5 0 0 1 1 0v2.5a2 2 0 0 1-2 2H2a2 2 0 0 1-2-2v-2.5a.5.5 0 0 1 .5-.5z"/>
                <path d="M7.646 11.854a.5.5 0 0 0 .708 0l3-3a.5.5 0 0 0-.708-.708L8.5 10.293V1.5a.5.5 0 0 0-1 0v8.793L5.354 8.146a.5.5 0 1 0-.708.708l3 3z"/>
            </svg> 
            Exportar CSV
        </button>

        <div class="table-responsive">
            <table class="table table-striped table-bordered text-center align-middle">
                <thead class="table-dark">
                    <tr>
                        <th>Linha</th>
                        <th>Início da Parada</th>
                        <th>Fim da Parada</th>
                        <th style="min-width: 250px;">Motivo da Parada</th>
                    </tr>
                </thead>
                <tbody>
                    {% for parada in paradas %}
                    <tr>
                        <td>{{ parada.nome_linha }}</td>
                        <td>{{ parada.inicio_parada }}</td>
                        <td>{{ parada.fim_parada|default:"Ainda em parada" }}</td>
                        <td class="text-start">
                            <fieldset>
                                <div class="form-check">
                                    <input class="form-check-input" type="radio" name="motivo_{{ forloop.counter }}" id="setup_{{ forloop.counter }}" value="setup"
                                        onclick="enviarMotivo('{{ parada.nome_linha }}', '{{ parada.inicio_parada }}', '{{ parada.fim_parada }}', 'setup')">
                                    <label class="form-check-label" for="setup_{{ forloop.counter }}">Setup</label>
                                </div>
                                <div class="form-check">
                                    <input class="form-check-input" type="radio" name="motivo_{{ forloop.counter }}" id="refeicao_{{ forloop.counter }}" value="refeicao"
                                        onclick="enviarMotivo('{{ parada.nome_linha }}', '{{ parada.inicio_parada }}', '{{ parada.fim_parada }}', 'refeicao')">
                                    <label class="form-check-label" for="refeicao_{{ forloop.counter }}">Refeição</label>
                                </div>
                                <div class="form-check">
                                    <input class="form-check-input" type="radio" name="motivo_{{ forloop.counter }}" id="manutencao_{{ forloop.counter }}" value="manutencao"
                                        onclick="enviarMotivo('{{ parada.nome_linha }}', '{{ parada.inicio_parada }}', '{{ parada.fim_parada }}', 'manutencao')">
                                    <label class="form-check-label" for="manutencao_{{ forloop.counter }}">Manutenção</label>
                                </div>
                                <div class="form-check">
                                    <input class="form-check-input" type="radio" name="motivo_{{ forloop.counter }}" id="logistica_{{ forloop.counter }}" value="logistica"
                                        onclick="enviarMotivo('{{ parada.nome_linha }}', '{{ parada.inicio_parada }}', '{{ parada.fim_parada }}', 'logistica')">
                                    <label class="form-check-label" for="logistica_{{ forloop.counter }}">Logística</label>
                                </div>
                                <div class="form-check">
                                    <input class="form-check-input" type="radio" name="motivo_{{ forloop.counter }}" id="externo_{{ forloop.counter }}" value="externo"
                                        onclick="enviarMotivo('{{ parada.nome_linha }}', '{{ parada.inicio_parada }}', '{{ parada.fim_parada }}', 'externo')">
                                    <label class="form-check-label" for="externo_{{ forloop.counter }}">Externo</label>
                                </div>
                            </fieldset>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>

    <div class="modal fade" id="modalExportar" tabindex="-1" aria-labelledby="modalExportarLabel" aria-hidden="true">
        <div class="modal-dialog modal-sm">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="modalExportarLabel">Exportar CSV</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body text-center">
                    <p>Selecione o período:</p>
                    <button type="button" class="btn btn-secondary" onclick="baixarCSV('7dias')">Últimos 7 dias</button>
                    <button type="button" class="btn btn-secondary" onclick="baixarCSV('1mes')">Último mês</button>
                    <button type="button" class="btn btn-secondary" onclick="baixarCSV('6meses')">Últimos 6 meses</button>
                    <button type="button" class="btn btn-secondary" onclick="baixarCSV('1ano')">Último ano</button>
                    <button type="button" class="btn btn-secondary mb-3" onclick="baixarCSV('todos')">Todo o banco</button>
                    <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Cancelar</button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js" crossorigin="anonymous"></script>
</body>
</html>
